# Email-уведомления в InstrumentTracker

## Описание
Модуль автоматически отправляет email-уведомления сотрудникам о сроках возврата инструментов:
- **За 1 день** до истечения срока (предупреждение)
- **В день истечения** срока (критическое уведомление)
- **При просрочке** (уведомление о просрочке)

## Настройка для Yandex почты

### 1. Получить пароль приложения Yandex

1. Войдите в свою почту на [Yandex](https://mail.yandex.ru)
2. Перейдите в настройки → **Безопасность**
3. Включите **Двухфакторную аутентификацию** (если еще не включена)
4. Создайте **Пароль приложения**:
   - Название: `InstrumentTracker`
   - Скопируйте сгенерированный пароль

### 2. Настройка в коде

В файле `main.py` найдите строки (примерно 59-62):

```python
# ВРЕМЕННО: Настройка email для тестирования
# TODO: Добавить настройку через интерфейс
# self.notification_manager.configure_email('your-email@yandex.ru', 'your-app-password')
# self.notification_manager.start_email_checking(interval_ms=3600000)  # Проверка раз в час
```

Раскомментируйте последние 2 строки и вставьте свои данные:

```python
# ВРЕМЕННО: Настройка email для тестирования
# TODO: Добавить настройку через интерфейс
self.notification_manager.configure_email('AlexAndreev132@yandex.ru', 'ваш_пароль_приложения')
self.notification_manager.start_email_checking(interval_ms=3600000)  # Проверка раз в час
```

### 3. Добавление email сотрудников

Email сотрудников должны быть указаны в таблице `Employees` в БД.

Вы можете добавить/изменить email через SQL:

```sql
UPDATE Employees 
SET email = 'employee@example.com' 
WHERE employee_id = 1;
```

## Тестирование

Используйте скрипт `test_email.py`:

```bash
python test_email.py
```

Меню тестирования:
1. **Показать список уведомлений** - просмотр всех pending уведомлений из БД
2. **Отправить тестовое письмо** - отправка тестового письма на указанный email
3. **Проверить и отправить реальные уведомления** - отправка реальных уведомлений из БД

### Пример тестирования:

```bash
$ python test_email.py

==================================================
Тестирование Email-уведомлений
==================================================
1. Показать список уведомлений
2. Отправить тестовое письмо
3. Проверить и отправить реальные уведомления
0. Выход
==================================================

Выберите действие: 2

=== Тест Email-уведомлений ===

Введите email отправителя: AlexAndreev132@yandex.ru
Введите пароль приложения: ваш_пароль
Введите тестовый email получателя: test@example.com

Отправка тестового письма на test@example.com...
Email отправлен: test@example.com - ⚠️ СЕГОДНЯ срок возврата: Дрель BOSCH GSR 12V
✓ Тестовое письмо успешно отправлено!
```

## Как работает

### Архитектура

```
notification_manager.py
    ↓
email_notifier.py
    ↓
SMTP (smtp.yandex.ru:587)
    ↓
Сотрудники получают email
```

### Частота проверки

- **Визуальные уведомления**: каждую минуту (60 секунд)
- **Email-уведомления**: каждый час (3600 секунд)

Можно изменить интервал при вызове:

```python
# Проверка каждые 30 минут
self.notification_manager.start_email_checking(interval_ms=1800000)

# Проверка каждые 4 часа
self.notification_manager.start_email_checking(interval_ms=14400000)
```

### Шаблон письма

Email отправляется в формате HTML с:
- Цветовой индикацией срочности (желтый/оранжевый/красный)
- Информацией об инструменте и сроке
- Текстовой версией для старых почтовых клиентов

## Безопасность

⚠️ **ВАЖНО:**
- Никогда не коммитьте пароли в Git!
- Используйте **пароль приложения**, а не основной пароль почты
- Храните пароли в переменных окружения или конфигурационных файлах вне репозитория

## Требования

Модуль использует стандартные библиотеки Python:
- `smtplib` - отправка email
- `email` - создание MIME-сообщений

Дополнительных зависимостей не требуется.

## Будущие улучшения

- [ ] Интерфейс настройки email в приложении (не в коде)
- [ ] Поддержка других SMTP-серверов (Gmail, Mail.ru)
- [ ] Настройка шаблонов писем через UI
- [ ] История отправленных уведомлений
- [ ] Отключение уведомлений для конкретных сотрудников
- [ ] Тестовая отправка через UI

## Поддержка других почтовых сервисов

### Gmail

```python
notifier = EmailNotifier(
    smtp_server='smtp.gmail.com',
    smtp_port=587
)
notifier.configure('your-email@gmail.com', 'app-password')
```

### Mail.ru

```python
notifier = EmailNotifier(
    smtp_server='smtp.mail.ru',
    smtp_port=587
)
notifier.configure('your-email@mail.ru', 'app-password')
```

## Отладка

Если письма не отправляются:

1. **Проверьте пароль приложения** - используйте именно app password, а не основной
2. **Проверьте email в БД** - должны быть указаны корректные email сотрудников
3. **Проверьте настройки Yandex** - разрешена ли отправка через SMTP
4. **Посмотрите логи** - в консоли выводятся сообщения об ошибках
5. **Используйте test_email.py** - сначала протестируйте отправку

## Примеры запросов к БД

### Добавить email сотруднику

```sql
UPDATE Employees 
SET email = 'ivanov@example.com' 
WHERE last_name = 'Иванов' AND first_name = 'Иван';
```

### Посмотреть всех сотрудников без email

```sql
SELECT employee_id, last_name, first_name, email 
FROM Employees 
WHERE email IS NULL OR email = '';
```

### Добавить email при создании сотрудника

```sql
INSERT INTO Employees (last_name, first_name, patronymic, position_id, phone, email)
VALUES ('Петров', 'Петр', 'Петрович', 1, '+79991234567', 'petrov@example.com');
```
